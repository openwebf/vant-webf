import{c as _,A as V,x as H,q as L,i as J,e as C,E as X,s as K,p as I}from"./use-translate.b9b887aa.js";import{n as Q,d as W,c as R,m as P,t as k,b as Y,w as Z}from"./with-install.78f37d35.js";import{u as $}from"./use-expose.f430d209.js";import{I as F}from"./index.ee2eceac.js";import{I as ee}from"./function-call.a54715de.js";import{c as ae}from"./interceptor.e861aa70.js";import{I as te}from"./index.27542769.js";import{L as ne}from"./index.9ca1885c.js";import{z as D,e as r,C as le,J as re,A as ie,H as oe}from"./vue-libs.b44bc779.js";const[se,i,ce]=_("uploader");function S(e,t){return new Promise(o=>{if(t==="file"){o();return}const c=new FileReader;c.onload=m=>{o(m.target.result)},t==="dataUrl"?c.readAsDataURL(e):t==="text"&&c.readAsText(e)})}function O(e,t){return V(e).some(o=>o.file?H(t)?t(o.file):o.file.size>t:!1)}function ue(e,t){const o=[],c=[];return e.forEach(m=>{O(m,t)?c.push(m):o.push(m)}),{valid:o,invalid:c}}const de=/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg)/i,fe=e=>de.test(e);function B(e){return e.isImage?!0:e.file&&e.file.type?e.file.type.indexOf("image")===0:e.url?fe(e.url):typeof e.content=="string"?e.content.indexOf("data:image")===0:!1}const me=D({props:{name:Q,item:W(Object),index:Number,imageFit:String,lazyLoad:Boolean,deletable:Boolean,previewSize:[Number,String,Array],beforeDelete:Function},emits:["delete","preview"],setup(e,{emit:t,slots:o}){const c=()=>{const{status:n,message:u}=e.item;if(n==="uploading"||n==="failed"){const p=n==="failed"?r(F,{name:"close",class:i("mask-icon")},null):r(ne,{class:i("loading")},null),f=J(u)&&u!=="";return r("div",{class:i("mask")},[p,f&&r("div",{class:i("mask-message")},[u])])}},m=n=>{const{name:u,item:p,index:f,beforeDelete:z}=e;n.stopPropagation(),ae(z,{args:[p,{name:u,index:f}],done:()=>t("delete")})},v=()=>t("preview"),b=()=>{if(e.deletable&&e.item.status!=="uploading"){const n=o["preview-delete"];return r("div",{role:"button",class:i("preview-delete",{shadow:!n}),tabindex:0,"aria-label":ce("delete"),onClick:m},[n?n():r(F,{name:"cross",class:i("preview-delete-icon")},null)])}},y=()=>{if(o["preview-cover"]){const{index:n,item:u}=e;return r("div",{class:i("preview-cover")},[o["preview-cover"](C({index:n},u))])}},h=()=>{const{item:n,lazyLoad:u,imageFit:p,previewSize:f}=e;return B(n)?r(te,{fit:p,src:n.content||n.url,class:i("preview-image"),width:Array.isArray(f)?f[0]:f,height:Array.isArray(f)?f[1]:f,lazyLoad:u,onClick:v},{default:y}):r("div",{class:i("file"),style:L(e.previewSize)},[r(F,{class:i("file-icon"),name:"description"},null),r("div",{class:[i("file-name"),"van-ellipsis"]},[n.file?n.file.name:n.url]),y()])};return()=>r("div",{class:i("preview")},[h(),c(),b()])}}),ve={name:R(""),accept:P("image/*"),capture:String,multiple:Boolean,disabled:Boolean,readonly:Boolean,lazyLoad:Boolean,maxCount:R(1/0),imageFit:P("cover"),resultType:P("dataUrl"),uploadIcon:P("photograph"),uploadText:String,deletable:k,afterRead:Function,showUpload:k,modelValue:Y(),beforeRead:Function,beforeDelete:Function,previewSize:[Number,String,Array],previewImage:k,previewOptions:Object,previewFullImage:k,maxSize:{type:[Number,String,Function],default:1/0}},ge=D({name:se,props:ve,emits:["delete","oversize","click-upload","close-preview","click-preview","update:modelValue"],setup(e,{emit:t,slots:o}){const c=le(),m=[],v=(a=e.modelValue.length)=>({name:e.name,index:a}),b=()=>{c.value&&(c.value.value="")},y=a=>{if(b(),O(a,e.maxSize))if(Array.isArray(a)){const l=ue(a,e.maxSize);if(a=l.valid,t("oversize",l.invalid,v()),!a.length)return}else{t("oversize",a,v());return}a=oe(a),t("update:modelValue",[...e.modelValue,...V(a)]),e.afterRead&&e.afterRead(a,v())},h=a=>{const{maxCount:l,modelValue:d,resultType:s}=e;if(Array.isArray(a)){const g=+l-d.length;a.length>g&&(a=a.slice(0,g)),Promise.all(a.map(w=>S(w,s))).then(w=>{const q=a.map((G,A)=>{const U={file:G,status:"",message:""};return w[A]&&(U.content=w[A]),U});y(q)})}else S(a,s).then(g=>{const w={file:a,status:"",message:""};g&&(w.content=g),y(w)})},n=a=>{const{files:l}=a.target;if(e.disabled||!l||!l.length)return;const d=l.length===1?l[0]:[].slice.call(l);if(e.beforeRead){const s=e.beforeRead(d,v());if(!s){b();return}if(K(s)){s.then(g=>{h(g||d)}).catch(b);return}}h(d)};let u;const p=()=>t("close-preview"),f=a=>{if(e.previewFullImage){const l=e.modelValue.filter(B),d=l.map(s=>(s.file&&!s.url&&s.status!=="failed"&&(s.url=URL.createObjectURL(s.file),m.push(s.url)),s.url)).filter(Boolean);u=ee(C({images:d,startPosition:l.indexOf(a),onClose:p},e.previewOptions))}},z=()=>{u&&u.close()},j=(a,l)=>{const d=e.modelValue.slice(0);d.splice(l,1),t("update:modelValue",d),t("delete",a,v(l))},E=(a,l)=>{const d=["imageFit","deletable","previewSize","beforeDelete"],s=C(I(e,d),I(a,d,!0));return r(me,ie({item:a,index:l,onClick:()=>t("click-preview",a,v(l)),onDelete:()=>j(a,l),onPreview:()=>f(a)},I(e,["name","lazyLoad"]),s),I(o,["preview-cover","preview-delete"]))},N=()=>{if(e.previewImage)return e.modelValue.map(E)},x=a=>t("click-upload",a),M=()=>{if(e.modelValue.length>=e.maxCount||!e.showUpload)return;const a=e.readonly?null:r("input",{ref:c,type:"file",class:i("input"),accept:e.accept,capture:e.capture,multiple:e.multiple,disabled:e.disabled,onChange:n},null);return o.default?r("div",{class:i("input-wrapper"),onClick:x},[o.default(),a]):r("div",{class:i("upload",{readonly:e.readonly}),style:L(e.previewSize),onClick:x},[r(F,{name:e.uploadIcon,class:i("upload-icon")},null),e.uploadText&&r("span",{class:i("upload-text")},[e.uploadText]),a])},T=()=>{c.value&&!e.disabled&&c.value.click()};return re(()=>{m.forEach(a=>URL.revokeObjectURL(a))}),$({chooseFile:T,closeImagePreview:z}),X(()=>e.modelValue),()=>r("div",{class:i()},[r("div",{class:i("wrapper",{disabled:e.disabled})},[N(),M()])])}}),pe=Z(ge),Ce=pe;export{Ce as V};
